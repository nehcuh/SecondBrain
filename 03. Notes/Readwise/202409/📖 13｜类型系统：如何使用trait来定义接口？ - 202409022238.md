---
title: ğŸ“– 13ï½œç±»å‹ç³»ç»Ÿï¼šå¦‚ä½•ä½¿ç”¨traitæ¥å®šä¹‰æ¥å£ï¼Ÿ
createdAt: 2024-09-02 22:38
notebook: "[[ğŸ—‚ï¸ Rust ç¼–ç¨‹ç¬¬ä¸€è¯¾]]"
allDay: 
startTime: 
endTime: 
date: 2024-09-02
project: 
area: 
resource: 
archived: 
tags:
  - "#readwise"
  - "#note/ğŸ€"
links: 
due: 2024-09-02
nextReview: 2024-09-09
status: "#done"
---

# åŸæ–‡æ‘˜è¦
> [!tip] 
> å°†åŸå§‹æ–‡ç« ä¸­çš„è¾ƒä¸ºé‡è¦çš„ä¿¡æ¯ã€Œæ‘˜å½•ã€åˆ°ç¬”è®°å½“ä¸­ï¼Œå¯¹ä¸€äº›ç¨å¾®é‡è¦çš„ä¿¡æ¯è¿›è¡Œã€ŒåŠ ç²—å¤„ç†ã€ï¼ˆç”¨ä¸€å¯¹Â ** åŒ…è£¹ç€å†…å®¹ï¼‰ï¼Œåœ¨æœªæ¥ã€Œå›çœ‹ç¬”è®°ã€æ—¶å¿«é€Ÿç†è§£ç¬¬ä¸€å±‚ä¿¡æ¯

ä»Šå¤©æˆ‘ä»¬ç»§ç»­è®²å¤šæ€ä¸­å¦å¤–ä¸¤ç§æ–¹å¼ï¼šç‰¹è®¾å¤šæ€å’Œå­ç±»å‹å¤šæ€ï¼Œçœ‹çœ‹å®ƒä»¬èƒ½ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜ã€å¦‚ä½•å®ç°ã€å¦‚ä½•ä½¿ç”¨ã€‚å¦‚æœä½ ä¸å¤ªè®°å¾—è¿™ä¸¤ç§å¤šæ€çš„å®šä¹‰ï¼Œæˆ‘ä»¬ç®€å•å›é¡¾ä¸€ä¸‹ï¼š**ç‰¹è®¾å¤šæ€**åŒ…æ‹¬è¿ç®—ç¬¦é‡è½½ï¼Œæ˜¯**æŒ‡åŒä¸€ç§è¡Œä¸ºæœ‰å¾ˆå¤šä¸åŒçš„å®ç°**ï¼›è€Œ**æŠŠå­ç±»å‹å½“æˆçˆ¶ç±»å‹ä½¿ç”¨**ï¼Œæ¯”å¦‚ Cat å½“æˆ Animal ä½¿ç”¨ï¼Œå±äº**å­ç±»å‹å¤šæ€**ã€‚
è¿™ä¸¤ç§å¤šæ€çš„å®ç°åœ¨ Rust ä¸­éƒ½å’Œ `trait` æœ‰å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—å…ˆæ¥äº†è§£ä¸€ä¸‹ trait æ˜¯ä»€ä¹ˆï¼Œå†çœ‹æ€ä¹ˆç”¨ trait æ¥å¤„ç†è¿™ä¸¤ç§å¤šæ€ã€‚

## ä»€ä¹ˆæ˜¯ trait

`trait` æ˜¯ Rust ä¸­çš„æ¥å£ï¼Œå®ƒå®šä¹‰äº†**ç±»å‹ä½¿ç”¨è¿™ä¸ªæ¥å£çš„è¡Œä¸º**ã€‚åœ¨å¼€å‘å¤æ‚ç³»ç»Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šå¼ºè°ƒæ¥å£å’Œå®ç°è¦åˆ†ç¦»ã€‚å› ä¸ºè¿™æ˜¯ä¸€ç§è‰¯å¥½çš„è®¾è®¡ä¹ æƒ¯ï¼Œå®ƒæŠŠè°ƒç”¨è€…å’Œå®ç°è€…éš”ç¦»å¼€ï¼ŒåŒæ–¹åªè¦æŒ‰ç…§æ¥å£å¼€å‘ï¼Œå½¼æ­¤å°±å¯ä»¥ä¸å—å¯¹æ–¹å†…éƒ¨æ”¹åŠ¨çš„å½±å“ã€‚

trait å°±æ˜¯è¿™æ ·ã€‚å®ƒå¯ä»¥æŠŠæ•°æ®ç»“æ„ä¸­çš„è¡Œä¸ºå•ç‹¬æŠ½å–å‡ºæ¥ï¼Œä½¿å…¶å¯ä»¥åœ¨å¤šä¸ªç±»å‹ä¹‹é—´å…±äº«ï¼›ä¹Ÿå¯ä»¥ä½œä¸ºçº¦æŸï¼Œåœ¨æ³›å‹ç¼–ç¨‹ä¸­ï¼Œé™åˆ¶å‚æ•°åŒ–ç±»å‹å¿…é¡»ç¬¦åˆå®ƒè§„å®šçš„è¡Œä¸ºã€‚

## åŸºæœ¬ trait

æˆ‘ä»¬æ¥çœ‹çœ‹åŸºæœ¬ `trait` å¦‚ä½•å®šä¹‰ã€‚è¿™é‡Œï¼Œä»¥æ ‡å‡†åº“ä¸­ `std::io::Write` ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ª `trait` ä¸­å®šä¹‰äº†ä¸€ç³»åˆ—æ–¹æ³•çš„æ¥å£ï¼š
```rust
pub trait Write { 
	fn write(&mut self, buf: &[u8]) -> Result; 
	fn flush(&mut self) -> Result<()>; 
	fn write_vectored(&mut self, bufs: &[IoSlice<'_>]) -> ResultÂ { ... } 
	fn is_write_vectored(&self) -> bool { ... } 
	fn write_all(&mut self, buf: &[u8]) -> Result<()> { ... } 
	fn write_all_vectored(&mut self, bufs: &mut [IoSlice<'_>]) -> Result<()> { ... } 
	fn write_fmt(&mut self, fmt: Arguments<'_>) -> Result<()> { ... } 
	fn by_ref(&mut self) -> &mut Self where Self: Sized { ... }}
```
è¿™äº›æ–¹æ³•ä¹Ÿè¢«ç§°ä½œå…³è”å‡½æ•°ï¼ˆassociate functionï¼‰ã€‚åœ¨ `trait` ä¸­ï¼Œæ–¹æ³•å¯ä»¥æœ‰ç¼ºçœçš„å®ç°ï¼Œå¯¹äºè¿™ä¸ª `Write trait`ï¼Œä½ åªéœ€è¦å®ç° `write` å’Œ `flush` ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä»–éƒ½æœ‰ç¼ºçœå®ç°ã€‚å¦‚æœä½ æŠŠ `trait` ç±»æ¯”ä¸ºçˆ¶ç±»ï¼Œå®ç° `trait` çš„ç±»å‹ç±»æ¯”ä¸ºå­ç±»ï¼Œé‚£ä¹ˆç¼ºçœå®ç°çš„æ–¹æ³•å°±ç›¸å½“äºå­ç±»ä¸­å¯ä»¥é‡è½½ä½†ä¸æ˜¯å¿…é¡»é‡è½½çš„æ–¹æ³•ã€‚

åœ¨åˆšæ‰å®šä¹‰æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¢‘ç¹çœ‹åˆ°ä¸¤ä¸ªç‰¹æ®Šçš„å…³é”®å­—ï¼š`Self` å’Œ `self`:
- `Self` ä»£è¡¨å½“å‰çš„ç±»å‹ï¼Œæ¯”å¦‚ `File` ç±»å‹å®ç°äº† `Write`ï¼Œé‚£ä¹ˆå®ç°è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„ `Self` å°±æŒ‡ä»£ `File`ã€‚
- `self` åœ¨ç”¨ä½œæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ—¶ï¼Œå®é™…ä¸Šæ˜¯ `self: Self` çš„ç®€å†™ï¼Œæ‰€ä»¥ `&self` æ˜¯ `self: &Self`, è€Œ `&mut self` æ˜¯ `self: &mut Self`ã€‚

å…‰è®²å®šä¹‰ï¼Œç†è§£ä¸å¤ªæ·±åˆ»ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ª `BufBuilder` ç»“æ„å®ç° `Write trait`ï¼Œç»“åˆä»£ç æ¥è¯´æ˜ã€‚

```rust
use std::fmt;
use std::io::Write;

struct BufBuilder {
	buf: Vec<u8>
}

impl BufBuilder {
	pub fn new() -> Self {
		Self {
			buf: Vec::with_capacity(1024)
		}
	}
}

// å®ç° debug trait, æ‰“å°å­—ç¬¦ä¸²
impl fmt::Debug for BufBuilder {
	fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
		write!(f, "{}", String::from_utf8_lossy(&self.bufâ€˜))
	}
}

impl Write for BufBuilder {
	fn write(&mut self, buf: &[u8]) -> std::io::Result<usize> {
		// æŠŠ buf æ·»åŠ åˆ° BufBuilder çš„å°¾éƒ¨
		self.buf.extend_from_slice(buf);
		Ok(buf.len())
	}

	fn flush(&mut self) -> std::io::Result<()> {
		// ç”±äºæ˜¯åœ¨å†…å­˜ä¸­æ“ä½œï¼Œæ‰€ä»¥ä¸éœ€è¦ flush
		Ok(())
	}
}

fn main() {
	let mut buf = BufBuilder::new();
	buf.write_all(b"Hello World!").unwrap();
	println!("{:?}", buf);
}
```

ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å®ç°äº† `write` å’Œ `flush` æ–¹æ³•ï¼Œå…¶ä»–çš„æ–¹æ³•éƒ½ä½¿ç”¨äº†ç¼ºçœå®ç°ï¼Œè¿™æ · `BufBuilder` å¯¹ `Write trait` çš„å®ç°æ˜¯å®Œæ•´çš„ã€‚å¦‚æœæ²¡æœ‰ `write` æˆ–è€… `flush`, Rust ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚

æ•°æ®ç»“æ„ä¸€æ—¦å®ç°äº†æŸä¸ª `trait`, é‚£ä¹ˆè¿™ä¸ª `trait` å†…éƒ¨çš„æ–¹æ³•éƒ½å¯ä»¥è¢«ä½¿ç”¨ï¼Œæ¯”å¦‚è¿™é‡Œä½¿ç”¨äº† `buf.write_all()`.

### åŸºæœ¬ trait ç»ƒä¹ 
```ad-quote
å‡è®¾æˆ‘ä»¬è¦åšä¸€ä¸ªå­—ç¬¦ä¸²è§£æå™¨ï¼Œå¯ä»¥æŠŠå­—ç¬¦ä¸²çš„æŸéƒ¨åˆ†è§£ææˆæŸä¸ªç±»å‹ã€‚
```

å¯ä»¥è¿™ä¹ˆå®šä¹‰è¿™ä¸ª `trait`: å®ƒæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯ `parse`, è¿™ä¸ªæ–¹æ³•æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²é¥®ç”¨ï¼Œè¿”å› `Self`.

```rust
pub trait Parse {
	fn parse(s: &str) -> Self;
}
```

è¿™ä¸ª `parse` æ–¹æ³•æ˜¯ `trait` çš„é™æ€æ–¹æ³•ï¼Œå› ä¸ºå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°å’Œ `self` æ— å…³ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨æ—¶éœ€è¦ä½¿ç”¨ `T::parse(str)`.

æˆ‘ä»¬å°è¯•ä¸º `u8` è¿™ä¸ªæ•°æ®ç»“æ„æ¥å®ç° `parse`, æ¯”å¦‚è¯´ `123abc` ä¼šè¢«è§£æå‡ºæ•´æ•° `123`, è€Œ `abcd` ä¼šè¢«è§£æå‡º `0`. æ•´ä¸ªä»£ç å¦‚ä¸‹ï¼š

```rust
use regex::Regex;

pub trait Parser {
	fn parse(s: &str) -> Self;
}

impl Parser for u8 {
	fn parse(s: &str) -> Self {
		let re: Regex = Regex::new(r"^[0-9]+").unwrap();
		if let Some(captures) = re.captures(s) {
			// å–ç¬¬ä¸€ä¸ª match, å°†å…¶æ•è·çš„ digit è½¬æ¢ä¸º u8
			captures
				.get(0)
				.map_or(0, |s| s.as_str().parse().unwrap_or(0))
		} else {
			0
		}
	}
}

#[test]
fn parse_should_work {
	assert_eq!(u8::parse("123abcd"), 123);
	assert_eq!(u8::parse("1234abcd"), 0);
	assert_eq!(u8::parse("abcd"), 0);
}

fn main() { 
	println!("result: {}", u8::parse("255 hello world"));
}
```

åœ¨å®ç° `trait` çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ç”¨æ³›å‹å‚æ•°æ¥å®ç° `trait`, éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦å¯¹æ³›å‹å‚æ•°åšä¸€å®šçš„é™åˆ¶ã€‚
- ç¬¬ä¸€ï¼Œä¸æ˜¯ä»»ä½•ç±»å‹éƒ½å¯ä»¥é€šè¿‡å­—ç¬¦ä¸²è§£æå‡ºæ¥ï¼Œåœ¨ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å¤„ç†æ•°å­—ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œå¯¹æ³›å‹å‚æ•°ç¬¬ä¸€ä¸ªé™åˆ¶æ˜¯ï¼Œå®ƒå¿…é¡»å®ç°äº† `FromStr` trait.
- ç¬¬äºŒï¼Œä¸Šé¢ä»£ç å½“æ— æ³•æ­£ç¡®è§£æå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œä¼šç›´æ¥è¿”å› 0ï¼Œè¡¨ç¤ºæ— æ³•å¤„ç†ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨æ³›å‹å‚æ•°åï¼Œæ— æ³•è¿”å› 0ï¼Œå› ä¸º 0 ä¸ä¸€å®šæ˜¯æŸä¸ªç¬¦åˆæ³›å‹å‚æ•°çš„ç±»å‹ä¸­çš„ä¸€ä¸ªå€¼ã€‚æ€ä¹ˆåŠï¼Ÿ

å…¶å®è¿”å› 0 çš„ç›®çš„æ˜¯ä¸ºå¤„ç†ä¸äº†çš„æƒ…å†µï¼Œè¿”å›ä¸€ä¸ªç¼ºçœå€¼ï¼Œåœ¨ Rust æ ‡å‡†åº“ä¸­æœ‰ `Default trait`ï¼Œç»å¤§å¤šæ•°ç±»å‹éƒ½å®ç°äº†è¿™ä¸ª `trait`ï¼Œæ¥ä¸ºæ•°æ®ç»“æ„æä¾›ç¼ºçœå€¼ï¼Œæ‰€ä»¥æ³›å‹å‚æ•°çš„å¦ä¸€ä¸ªé™åˆ¶æ˜¯ `Default`ã€‚

```rust
use std::str::FromStr;
use regex::Regex;

pub trait Parse {
	fn parse(s: &str) -> Self;
}

// æˆ‘ä»¬çº¦æŸ T å¿…é¡»åŒæ—¶å®ç°äº† FromStr å’Œ Default
// è¿™æ ·åœ¨ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ç”¨è¿™ä¸¤ä¸ª trait çš„æ–¹æ³•äº†
impl<T> Parse for T
where T: FromStr + Default 
{
	fn parse(s: &str) -> Self {
		let re: Regex = Regex::new(r"^[0-9]+(\.[0-9]+)?").unwrap();
		// ç”Ÿæˆä¸€ä¸ªåˆ›å»ºç¼ºçœå€¼çš„é—­åŒ…ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ç®€åŒ–åç»­ä»£ç 
		// Default::default() è¿”å›çš„ç±»å‹æ ¹æ®ä¸Šä¸‹æ–‡èƒ½æ¨å¯¼å‡ºæ¥ï¼Œæ˜¯ Self
		// è€Œæˆ‘ä»¬çº¦å®šäº† Selfï¼Œä¹Ÿå°±æ˜¯ T éœ€è¦å®ç° Default trait
		let d = || Default::default();
		if let Some(captures) = re.captures(s) {
			captures
				.get(0)
				.map_or(d(), |s| s.as_str().parse().unwrap_or(d()))
		} else {
			d()
		}
	}
}

#[test]
fn parse_should_work() {
	assert_eq!(u32::parse("123abcd"), 123);
	assert_eq!(u32::parse("123.45abcd"), 0);
	assert_eq!(f64::parse("123.45abcd"), 123.45);
	assert_eq!(f64::parse("abcd"), 0f64);
}

fn main() {
	println!("result: {}", u8::parse("255 hello world"));
}
```

é€šè¿‡å¯¹å¸¦æœ‰çº¦æŸçš„æ³›å‹å‚æ•°å®ç° `trait`, ä¸€ä»½ä»£ç å®ç°äº† u32/f64 ç­‰ç±»å‹çš„ `Parse trait`. ä½†æ— æ³•æ­£ç¡®è§£æå­—ç¬¦ä¸²æ—¶ï¼Œæˆ‘ä»¬è¿”å›äº†ç¼ºçœå€¼ï¼Œéš¾é“ä¸æ˜¯åº”è¯¥è¿”å›ä¸€ä¸ªé”™è¯¯ä¹ˆï¼Ÿæ˜¯çš„ï¼Œ**è¿™é‡Œè¿”å›ç¼ºçœå€¼çš„è¯ï¼Œä¼šè·Ÿè§£æ "0abcd" è¿™æ ·çš„æƒ…å†µæ··æ·†ï¼Œä¸çŸ¥é“è§£æå‡ºçš„ `0`ï¼Œç©¶ç«Ÿæ˜¯å‡ºé”™äº†ï¼Œè¿˜æ˜¯æœ¬è¯¥è§£æå‡º `0`**. æ‰€ä»¥æ›´å¥½çš„æ–¹å¼æ˜¯ `parse` å‡½æ•°è¿”å›ä¸€ä¸ª `Result<T, E>`.

```rust
pub trait Parse {
	fn parse(s: &str) -> Result<Self, E>;
}
```

ä½†è¿™é‡Œçš„ `Result` çš„ `E` è®©äººçŠ¯éš¾äº†ï¼šè¦è¿”å›çš„é”™è¯¯ä¿¡æ¯ï¼Œåœ¨ `trait` å®šä¹‰æ—¶å¹¶ä¸ç¡®å®šï¼Œä¸åŒçš„å®ç°è€…å¯ä»¥ä½¿ç”¨ä¸åŒçš„é”™è¯¯ç±»å‹ï¼Œè¿™é‡Œçš„ `trait` çš„å®šä¹‰è€…æœ€å¥½èƒ½å¤ŸæŠŠè¿™ç§çµæ´»æ€§ç•™ç»™ `trait` çš„å®ç°è€…ï¼Œæ€ä¹ˆåŠï¼Ÿ

## å¸¦å…³è”ç±»å‹çš„ trait
Rust å…è®¸ `trait` å†…éƒ¨åŒ…å«å…³è”ç±»å‹ï¼Œå®ç°æ—¶è·Ÿå…³è”å‡½æ•°ä¸€æ ·ï¼Œå®ƒä¹Ÿéœ€è¦å®ç°å…³è”ç±»å‹ã€‚æˆ‘ä»¬çœ‹æ€ä¹ˆä¸º `Parse trait` æ·»åŠ å…³è”ç±»å‹ï¼š

```rust
pub trait Parse {
	type Error;
	fn parse(s: &str) -> Result<Self, Self::Error>;
}
```

æœ‰äº†å…³è”ç±»å‹ `Error`, `Parse trait` å°±å¯ä»¥åœ¨å‡ºé”™æ—¶è¿”å›åˆç†çš„é”™è¯¯äº†ï¼Œçœ‹ä¿®æ”¹åçš„ä»£ç ï¼š

```rust
use std::str::FromStr;
use regex::Regex;

pub trait Parse {
	type Error;
	fn parse(s: &str) -> Result<Self, Self::Error>
	where 
		Self: Sized;
}

impl<T> Parse for T
where
	T: FromStr + Default
{
	// å®šä¹‰å…³è”ç±»å‹ Error ä¸º String
	type Error = String;
	fn parse(s: &str) -> Result<Self, Self::Error> {
		let re: Regex = Regex::new(r"^[0-9]+(\.[0-9]+)?").unwrap();	
		if let Some(captures) = re.captures(s) {
			captures
				.get(0)	
				.map_or(Err("failed to capture".to_string()), |s| {
					s.as_str()
						.parse()
						.map_err(|_err| "failed to parse captured string".to_string())	
				})
		} else {
			Err("failed to parse string".to_string())
		}
	}
}

#[test]
fn parse_should_work() { 
	assert_eq!(u32::parse("123abcd"), Ok(123)); 
	assert_eq!(u32::parse("123.45abcd"), Err("failed to parse captured string".into())); 
	assert_eq!(f64::parse("123.45abcd"), Ok(123.45)); 
	assert!(f64::parse("abcd").is_err());
}

fn main() { 
	println!("result: {:?}", u8::parse("255 hello world"));
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å…è®¸ç”¨æˆ·æŠŠé”™è¯¯ç±»å‹å»¶è¿Ÿåˆ° `trait` å®ç°æ—¶æ‰å†³å®šï¼Œè¿™ç§å¸¦æœ‰å…³è”ç±»å‹çš„ `trait` æ¯”æ™®é€š `trait`ï¼Œæ›´åŠ çµæ´»ï¼ŒæŠ½è±¡åº¦æ›´é«˜ã€‚**`trait` æ–¹æ³•é‡Œçš„å‚æ•°æˆ–è€…è¿”å›å€¼ï¼Œéƒ½å¯ä»¥ç”¨å…³è”ç±»å‹æ¥è¡¨è¿°**ï¼Œè€Œåœ¨å®ç°æœ‰å…³è”ç±»å‹çš„ `trait` æ—¶ï¼Œåªéœ€è¦é¢å¤–æä¾›å…³è”ç±»å‹çš„å…·ä½“ç±»å‹å³å¯ã€‚

## æ”¯æŒæ³›å‹çš„ trait
ç»“åˆä¸Šä¸€è®²ä»‹ç»çš„æ³›å‹ï¼Œä½ æœ‰æ²¡æœ‰æƒ³åˆ°è¿™ä¸ªé—®é¢˜ï¼š`trait` çš„å®šä¹‰æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥æ”¯æŒæ³›å‹å‘¢ï¼Ÿæ¯”å¦‚è¦å®šä¹‰ä¸€ä¸ª `Concat` trait å…è®¸æ•°æ®ç»“æ„æ‹¼æ¥èµ·æ¥ï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶åœ°ï¼Œæˆ‘ä»¬å¸Œæœ› `String` å¯ä»¥å’Œ `String` æ‹¼æ¥ã€å’Œ `&str` æ‹¼æ¥ï¼Œç”šè‡³å’Œä»»ä½•èƒ½è½¬æ¢æˆ `String` çš„æ•°æ®ç»“æ„æ‹¼æ¥ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°±éœ€è¦ trait ä¹Ÿæ”¯æŒæ³›å‹äº†ã€‚

æ¥çœ‹çœ‹æ ‡å‡†åº“é‡Œçš„æ“ä½œç¬¦æ˜¯å¦‚ä½•é‡è½½çš„ï¼Œä»¥ `std::ops::Add` è¿™ä¸ªç”¨äºæä¾›åŠ æ³•è¿ç®—çš„ `trait` ä¸ºä¾‹ï¼š

```rust
pub trait Add<Rhs = Self> {
	type Output;
	#[must_use]
	fn add(self, rhs: Rhs) -> Self::Output;
}
```

è¿™ä¸ª trait æœ‰ä¸€ä¸ªæ³›å‹å‚æ•° `Rhs`ï¼Œä»£è¡¨åŠ å·å³è¾¹çš„å€¼ï¼Œå®ƒè¢«ç”¨åœ¨ `add` æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ä½ã€‚è¿™é‡Œ `Rhs` é»˜è®¤æ˜¯ `Self`ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ ç”¨ `Add` trait ï¼Œå¦‚æœä¸æä¾›æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆåŠ å·å³å€¼å’Œå·¦å€¼éƒ½è¦æ˜¯ç›¸åŒçš„ç±»å‹ã€‚

æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªå¤æ•°ç±»å‹ï¼Œå°è¯•ä½¿ç”¨ä¸‹è¿™ä¸ª trait:

```rust
use std::ops::Add;

#[derive(Debug)]
struct Complex {
	real: f64,
	imagine: f64
}

impl Complex {
	pub fn new(real: f64, image: f64) -> Self {
		Self {real, image}
	}
}

// å¯¹ Complex ç±»å‹çš„å®ç°
impl Add for Complex {
	type Output = Self;

	// æ³¨æ„ add ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼Œä¼šç§»åŠ¨æ‰€æœ‰æƒ
	fn add(self, rhs: Self) -> Self::Output {
		let real = self.real + rhs.real;
		let image = self.image + rhs.image;
		Self::new(real, image)
	}
}

fn main() {
	let c1 = Complex::new(1.0, 1f64);
	let c2 = Complex::new(2 as f64, 3.0);
	println!("{:?}", c1 + c2);
	// c1, c2 å·²ç»è¢«ç§»åŠ¨ï¼Œæ‰€ä»¥ä¸‹é¢è¿™å¥æ— æ³•ç¼–è¯‘
	// println!("{:?}", c1+c2);
}
```

`Add` trait å¯¹äºå®ç°äº† `Copy` trait çš„ç±»å‹å¦‚ `u32`, `f64` ç­‰ç»“æ„æ¥è¯´ï¼Œç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†å¯¹äºæˆ‘ä»¬å®šä¹‰çš„ `Complex` ç±»å‹ï¼Œæ‰§è¡Œä¸€æ¬¡åŠ æ³•ï¼ŒåŸæœ‰çš„å€¼å°±æ— æ³•ä½¿ç”¨ï¼Œå¾ˆä¸æ–¹ä¾¿ï¼Œæ€ä¹ˆåŠï¼Ÿèƒ½ä¸èƒ½å¯¹ `Complex` çš„å¼•ç”¨å®ç° `Add` trait å‘¢ï¼Ÿ å¯ä»¥çš„ï¼Œæˆ‘ä»¬ä¸º `&Complex` ä¹Ÿå®ç° `Add`:

```rust
// ...

// å¦‚æœä¸æƒ³ç§»åŠ¨æ‰€æœ‰æƒï¼Œå¯ä»¥ä¸º &Complex å®ç° addï¼Œè¿™æ ·å¯ä»¥åš &c1 + &c2
impl Add for &Complex {
    // æ³¨æ„è¿”å›å€¼ä¸åº”è¯¥æ˜¯ Self äº†ï¼Œå› ä¸ºæ­¤æ—¶ Self æ˜¯ &Complex
    type Output = Complex;

    fn add(self, rhs: Self) -> Self::Output {
        let real = self.real + rhs.real;
        let imagine = self.imagine + rhs.imagine;
        Complex::new(real, imagine)
    }
}

fn main() {
    let c1 = Complex::new(1.0, 1f64);
    let c2 = Complex::new(2 as f64, 3.0);
    println!("{:?}", &c1 + &c2);
    println!("{:?}", c1 + c2);
}
```

å¯ä»¥åš `&c1 + &c2` ï¼Œè¿™æ ·æ‰€æœ‰æƒå°±ä¸ä¼šç§»åŠ¨äº†ã€‚è¿™ä¸ªå°ä¾‹å­å®ç”¨æ€§ä¸å¤ªå¤Ÿï¼Œå†æ¥çœ‹ä¸€ä¸ªå®é™…å·¥ä½œä¸­å¯èƒ½ä¼šä½¿ç”¨åˆ°çš„æ³›å‹ traitï¼Œä½ å°±çŸ¥é“è¿™ä¸ªæ”¯æŒæœ‰å¤šå¼ºå¤§äº†ã€‚`tower::Service` æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªç²¾å·§çš„ç”¨äºå¤„ç†è¯·æ±‚ï¼Œè¿”å›å“åº”çš„ç»å…¸ traitï¼Œåœ¨ä¸å°‘è‘—åçš„ç¬¬ä¸‰æ–¹ç½‘ç»œåº“ä¸­éƒ½æœ‰ä½¿ç”¨ï¼Œæ¯”å¦‚å¤„ç† `gRPC` çš„ `tonic`. çœ‹ `Service` çš„å®šä¹‰ï¼š

```rust
// Service trait å…è®¸æŸä¸ª service çš„å®ç°å¤„ç†å¤šä¸ªä¸åŒçš„ Request
pub trait Service<Request> {
	type Response;
	type Error;
	// Future ç±»å‹å— Future trait çº¦æŸ
	type Future: Future;
	fn poll_ready(
		&mut self,
		cx: &mut Context<'_>
	) -> Poll<Result<(), Self::Error>>;
	fn call(&mut self, req: Request) -> Self::Future;
}
```

è¿™ä¸ª trait å…è®¸æŸä¸ª `Service` èƒ½å¤„ç†å¤šä¸ªä¸åŒçš„ `Request`ã€‚æˆ‘ä»¬åœ¨ Web å¼€å‘ä¸­ä½¿ç”¨è¯¥ trait çš„è¯ï¼Œæ¯ä¸ª Method+URL å¯ä»¥å®šä¹‰ä¸ºä¸€ä¸ª `Service`ï¼Œå…¶ `Request` æ˜¯è¾“å…¥ç±»å‹ã€‚

æ³¨æ„å¯¹äºæŸä¸ªç¡®å®šçš„ `Request` ç±»å‹ï¼Œåªä¼šè¿”å›ä¸€ç§ `Response`ï¼Œæ‰€ä»¥è¿™é‡Œ `Response` ä½¿ç”¨å…³è”ç±»å‹ï¼Œè€Œéæ³›å‹ã€‚å¦‚æœæœ‰å¯èƒ½è¿”å›å¤šä¸ª `Response`ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨æ³›å‹ `Service<Request, Response>`ã€‚

![[Pasted image 20240906201726.png]]

## trait çš„ "ç»§æ‰¿"
åœ¨ Rust ä¸­ï¼Œä¸€ä¸ª trait å¯ä»¥â€œç»§æ‰¿â€å¦ä¸€ä¸ª trait çš„å…³è”ç±»å‹å’Œå…³è”å‡½æ•°ã€‚æ¯”å¦‚ `trait B: A` ï¼Œæ˜¯è¯´ä»»ä½•ç±»å‹ `T`ï¼Œå¦‚æœå®ç°äº† `trait B`ï¼Œå®ƒä¹Ÿå¿…é¡»å®ç° `trait A`ï¼Œæ¢å¥è¯è¯´ï¼Œ`trait B` åœ¨å®šä¹‰æ—¶å¯ä»¥ä½¿ç”¨ `trait A` ä¸­çš„å…³è”ç±»å‹å’Œæ–¹æ³•ã€‚

## trait å°ç»“
ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œtrait ä½œä¸ºå¯¹ä¸åŒæ•°æ®ç»“æ„ä¸­ç›¸åŒè¡Œä¸ºçš„ä¸€ç§æŠ½è±¡ã€‚é™¤äº†åŸºæœ¬ trait ä¹‹å¤–ï¼Œ
- å½“è¡Œä¸ºå’Œå…·ä½“çš„æ•°æ®å…³è”æ—¶ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²è§£ææ—¶å®šä¹‰çš„ `Parse trait`ï¼Œæˆ‘ä»¬å¼•å…¥äº†å¸¦æœ‰å…³è”ç±»å‹çš„ traitï¼ŒæŠŠå’Œè¡Œä¸ºæœ‰å…³çš„æ•°æ®ç±»å‹çš„å®šä¹‰ï¼Œè¿›ä¸€æ­¥å»¶è¿Ÿåˆ° trait å®ç°çš„æ—¶å€™ã€‚
- å¯¹äºåŒä¸€ä¸ªç±»å‹çš„åŒä¸€ä¸ª trait è¡Œä¸ºï¼Œå¯ä»¥æœ‰ä¸åŒçš„å®ç°ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰å¤§é‡ä½¿ç”¨çš„ `From`ï¼Œæ­¤æ—¶å¯ä»¥ç”¨æ³›å‹ traitã€‚

## å¦‚ä½•åšå­ç±»å‹å¤šæ€
Rust è™½ç„¶æ²¡æœ‰çˆ¶ç±»å’Œå­ç±»ï¼Œä½† trait å’Œå®ç° trait çš„ç±»å‹ä¹‹é—´ä¹Ÿæ˜¯ç±»ä¼¼çš„å…³ç³»ï¼Œæ‰€ä»¥ï¼ŒRust ä¹Ÿå¯ä»¥åšå­ç±»å‹å¤šæ€ã€‚çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```rust
struct Cat;
struct Dog;

trait Animal {
	fn name(&self) -> &'static str;
}

impl Animal for Cat {
	fn name(&self) -> &'static str {
		"Cat"
	}
}

impl Animal for Dog {
	fn name(&self) -> &'static str {
		"Dog"
	}
}

fn name(animal: impl Animal) -> &'static str {
	animal.name()
}

fn main() {
	let cat = Cat;
	println!("cat: {}", name(cat));
}
```

ä¸Šä¸€è®²æåˆ°è¿‡ï¼Œè¿™ç§æ³›å‹å‡½æ•°ä¼šæ ¹æ®å…·ä½“ä½¿ç”¨çš„ç±»å‹è¢«å•æ€åŒ–ï¼Œç¼–è¯‘æˆå¤šä¸ªå®ä¾‹ï¼Œæ˜¯é™æ€åˆ†æ´¾ã€‚é™æ€åˆ†æ´¾å›ºç„¶å¾ˆå¥½ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œ**ä½†å¾ˆå¤šæ—¶å€™ï¼Œç±»å‹å¯èƒ½å¾ˆéš¾åœ¨ç¼–è¯‘æ—¶å†³å®š**ã€‚æ¯”å¦‚è¦æ’°å†™ä¸€ä¸ªæ ¼å¼åŒ–å·¥å…·ï¼Œè¿™ä¸ªåœ¨ IDE é‡Œå¾ˆå¸¸è§ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª `Formatter` æ¥å£ï¼Œç„¶ååˆ›å»ºä¸€ç³»åˆ—å®ç°ï¼š

```rust
pub trait Formatter {
	fn format(&self, input: &mut String) -> bool;
}

struct MarkdownFormatter;
impl Formatter for MarkdownFormatter {
	fn format(&self, input: &mut String) -> bool {
		input.push_str("\nformatted with Markdown formatter");
		true
	}
}

struct RustFormatter;
impl Formatter for RustFormatter {
	fn format(&self, input: &mut String) -> bool {
		input.push_str("\nformatted with Rust formatter");
		true
	}
}

struct HtmlFormatter;
impl Formatter for HtmlFormatter {
	fn format(&self, input: &mut String) -> bool {
		input.push_str("\nformatted with Html formatter");
		true
	}
}
```

é¦–å…ˆï¼Œä½¿ç”¨ä»€ä¹ˆæ ¼å¼åŒ–æ–¹æ³•ï¼Œåªæœ‰å½“æ‰“å¼€æ–‡ä»¶ï¼Œåˆ†æå‡ºæ–‡ä»¶å†…å®¹ä¹‹åæ‰èƒ½ç¡®å®šï¼Œæˆ‘ä»¬æ— æ³•åœ¨ç¼–è¯‘æœŸç»™å®šä¸€ä¸ªå…·ä½“ç±»å‹ã€‚å…¶æ¬¡ï¼Œä¸€ä¸ªæ–‡ä»¶å¯èƒ½æœ‰ä¸€åˆ°å¤šä¸ªæ ¼å¼åŒ–å·¥å…·ï¼Œæ¯”å¦‚ä¸€ä¸ª Markdown æ–‡ä»¶é‡Œæœ‰ Rust ä»£ç ï¼ŒåŒæ—¶éœ€è¦ `MarkdownFormatter` å’Œ `RustFormatter` æ¥æ ¼å¼åŒ–ã€‚è¿™é‡Œå¦‚æœä½¿ç”¨ä¸€ä¸ª `Vec<T>` æ¥æä¾›æ‰€æœ‰éœ€è¦çš„æ ¼å¼åŒ–å·¥å…·ï¼Œé‚£ä¹ˆä¸‹é¢è¿™ä¸ªå‡½æ•°å…¶ `formatters` å‚æ•°æ”¹å¦‚ä½•ç¡®å®šç±»å‹å‘¢ï¼Ÿ

```rust
pub fn format(input: &mut String, formatters: Vec<???>) {
	for formater in formatters {
		formatter.format(input)
	}
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œ `Vec<>` å®¹å™¨é‡Œçš„ç±»å‹éœ€è¦æ—¶ä¸€è‡´çš„ï¼Œä½†æ­¤å¤„æ— æ³•ç»™ä¸ä¸€ä¸ªä¸€è‡´çš„ç±»å‹ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æœ‰ä¸€ç§æ‰‹æ®µï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œæ­¤å¤„éœ€è¦å¹¶ä¸”ä»…éœ€è¦ä»»ä½•å®ç°äº† `Formatter` æ¥å£çš„æ•°æ®ç±»å‹ã€‚åœ¨ Rust é‡Œï¼Œè¿™ç§ç±»å‹å« `Trait Object`ï¼Œè¡¨ç°ä¸º `&dyn Trait` æˆ–è€… `Box`ã€‚

è¿™é‡Œï¼Œ`dyn` å…³é”®å­—åªæ˜¯ç”¨æ¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°åŒºåˆ†æ™®é€šç±»å‹å’Œ Trait ç±»å‹ï¼Œé˜…è¯»ä»£ç æ—¶ï¼Œçœ‹åˆ° `dyn` å°±çŸ¥é“åé¢è·Ÿçš„æ˜¯ä¸€ä¸ª trait äº†ã€‚äºæ˜¯ï¼Œä¸Šè¿°ä»£ç å¯ä»¥å†™æˆï¼š

```rust
pub fn formatter(input: &mut String, formatters: Vec<&dyn Formatter>) {
	for formatter in formatters {
		formatter.format(input);	
	}
}
```

è¿™æ ·å¯ä»¥åœ¨è¿è¡Œæ—¶ï¼Œæ„é€ ä¸€ä¸ª `Formatter` çš„åˆ—è¡¨ï¼Œä¼ é€’ç»™ `format` å‡½æ•°è¿›è¡Œæ–‡ä»¶çš„æ ¼å¼åŒ–ï¼Œè¿™å°±æ˜¯**åŠ¨æ€åˆ†æ´¾** (dynamic dispatching).

çœ‹æœ€ç»ˆè°ƒç”¨çš„æ ¼å¼åŒ–å·¥å…·ä»£ç ï¼š

```rust
pub trait Formatter {
    fn format(&self, input: &mut String) -> bool;
}

struct MarkdownFormatter;
impl Formatter for MarkdownFormatter {
    fn format(&self, input: &mut String) -> bool {
        input.push_str("\nformatted with Markdown formatter");
        true
    }
}

struct RustFormatter;
impl Formatter for RustFormatter {
    fn format(&self, input: &mut String) -> bool {
        input.push_str("\nformatted with Rust formatter");
        true
    }
}

struct HtmlFormatter;
impl Formatter for HtmlFormatter {
    fn format(&self, input: &mut String) -> bool {
        input.push_str("\nformatted with HTML formatter");
        true
    }
}

pub fn format(input: &mut String, formatters: Vec<&dyn Formatter>) {
    for formatter in formatters {
        formatter.format(input);
    }
}

fn main() {
    let mut text = "Hello world!".to_string();
    let html: &dyn Formatter = &HtmlFormatter;
    let rust: &dyn Formatter = &RustFormatter;
    let formatters = vec![html, rust];
    format(&mut text, formatters);

    println!("text: {}", text);
}
```

## Trait Object çš„å®ç°æœºç†
å½“éœ€è¦ä½¿ç”¨ `Formatter trait` åšåŠ¨æ€åˆ†æ´¾æ—¶ï¼Œå¯ä»¥å¦‚ä¸‹ä¾‹å­ä¸€æ ·ï¼Œå°†ä¸€ä¸ªå…·ä½“ç±»å‹çš„å¼•ç”¨ï¼Œèµ‹ç»™ `&Formatter`:

![[Pasted image 20240906203724.png]]

`HtmlFormatter` çš„å¼•ç”¨èµ‹å€¼ç»™ `Formatter` åï¼Œä¼šç”Ÿæˆä¸€ä¸ª `Trait Object`ï¼Œåœ¨ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ`Trait Object` çš„åº•å±‚é€»è¾‘å°±æ˜¯èƒ–æŒ‡é’ˆã€‚å…¶ä¸­ï¼Œä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°æ®æœ¬èº«ï¼Œå¦ä¸€ä¸ªåˆ™æŒ‡å‘è™šå‡½æ•°è¡¨(`vtable`)ã€‚

`vtable` æ˜¯ä¸€å¼ é™æ€çš„è¡¨ï¼ŒRust åœ¨ç¼–è¯‘æ—¶ä¼šä¸ºä½¿ç”¨äº† `Trait object` çš„ç±»å‹çš„ `trait` å®ç°ç”Ÿæˆä¸€å¼ è¡¨ï¼Œæ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ (ä¸€èˆ¬åœ¨ TEXT æˆ– RODATA æ®µ).

![[Pasted image 20240906204109.png]]

åœ¨è¿™å¼ è¡¨é‡Œï¼ŒåŒ…å«å…·ä½“ç±»å‹çš„ä¸€äº›ä¿¡æ¯ï¼Œå¦‚ `size`ã€`aligment` ä»¥åŠä¸€ç³»åˆ—å‡½æ•°æŒ‡é’ˆï¼šè¿™ä¸ªæ¥å£æ”¯æŒçš„æ‰€æœ‰çš„æ–¹æ³•ï¼Œæ¯”å¦‚ `format()` ï¼›å…·ä½“ç±»å‹çš„ `drop trait`ï¼Œå½“ `Trait object` è¢«é‡Šæ”¾ï¼Œå®ƒç”¨æ¥é‡Šæ”¾å…¶ä½¿ç”¨çš„æ‰€æœ‰èµ„æºã€‚

è¿™é‡Œè¯´å¥é¢˜å¤–è¯ï¼ŒC++ / Java æŒ‡å‘ `vtable` çš„æŒ‡é’ˆï¼Œåœ¨ç¼–è¯‘æ—¶æ”¾åœ¨ç±»ç»“æ„é‡Œï¼Œè€Œ Rust æ”¾åœ¨ `Trait object` ä¸­ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Rust å¾ˆå®¹æ˜“å¯¹åŸç”Ÿç±»å‹åšåŠ¨æ€åˆ†æ´¾ï¼Œè€Œ C++/Java ä¸è¡Œã€‚

ä¸è¿‡ï¼Œä½ ä½¿ç”¨ `Trait object` çš„æ—¶å€™ï¼Œè¦æ³¨æ„å¯¹è±¡å®‰å…¨(object safety)ã€‚åªæœ‰æ»¡è¶³å¯¹è±¡å®‰å…¨çš„ trait æ‰èƒ½ä½¿ç”¨ `Trait object`ï¼Œåœ¨[å®˜æ–¹æ–‡æ¡£](https://doc.rust-lang.org/book/ch17-02-trait-objects.html)[Using Trait Objects That Allow for Values of Different Types - The Rust Programming Language](https://doc.rust-lang.org/book/ch17-02-trait-objects.html)ä¸­æœ‰è¯¦ç»†è®¨è®ºã€‚

é‚£ä»€ä¹ˆæ ·çš„ `trait` ä¸æ˜¯å¯¹è±¡å®‰å…¨çš„å‘¢ï¼Ÿ**å¦‚æœ trait æ‰€æœ‰çš„æ–¹æ³•ï¼Œè¿”å›å€¼æ˜¯ `Self` æˆ–è€…æºå¸¦æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ª trait å°±ä¸èƒ½äº§ç”Ÿ trait objectã€‚**

ä¸å…è®¸è¿”å› `Self`, å› ä¸º `Trait Object` åœ¨äº§ç”Ÿæ—¶ï¼ŒåŸæ¥çš„ç±»å‹ä¼šè¢«æŠ¹å»ï¼Œæ‰€ä»¥ `Self` ç©¶ç«Ÿæ˜¯è°ä¸çŸ¥é“ã€‚æ¯”å¦‚ `Clone trait` åªæœ‰ä¸€ä¸ªæ–¹æ³• `clone()`, è¿”å› `Self`, æ‰€ä»¥å®ƒå°±ä¸èƒ½äº§ç”Ÿ `Trait object`.

ä¸å…è®¸æºå¸¦æ³›å‡½å‚æ•°ï¼Œæ˜¯å› ä¸º Rust é‡Œå¸¦æ³›å‡½çš„ç±»å‹ä¼šåœ¨ç¼–è¯‘æ—¶åšå•æ€åŒ–ï¼Œè€Œ `Trait object` æ˜¯è¿è¡Œæ—¶çš„äº§ç‰©ï¼Œä¸¤è€…ä¸èƒ½å…¼å®¹ã€‚æ¯”å¦‚ `From trait`, å› ä¸ºæ•´ä¸ª trait å¸¦äº†æ³›å‹ï¼Œæ¯ä¸ªæ–¹æ³•ä¹Ÿè‡ªç„¶åŒ…å«æ³›å‹ï¼Œå°±ä¸èƒ½äº§ç”Ÿ `Trait object`.

## å°ç»“
![[Pasted image 20240906204844.png]]

# é‡ç‚¹æ‘˜è¦
> [!tip] 
> åœ¨å®Œæˆã€Œç¬¬ä¸€å±‚ï¼šåŸæ–‡æ‘˜è¦ã€åé©¬ä¸Šå°±æ•´ç†ã€Œç¬¬äºŒå±‚ï¼šé‡ç‚¹æ‘˜è¦ã€ï¼Œè™½ç„¶éœ€è¦éµå¾ªã€Œä¸åŒçš„æ—¶é—´æ®µå®Œæˆä¸åŒå±‚çº§ã€çš„è§„åˆ™ï¼Œä½†æ˜¯åœ¨é˜…è¯»æˆ–æ•´ç†ç¬”è®°çš„å½“ä¸‹ï¼Œå¦‚æœè§‰å¾—æœ‰äº›å†…å®¹éœ€è¦é‡ç‚¹æ ‡æ³¨ï¼Œéœ€è¦ç¬¬ä¸€æ—¶é—´å°†ã€Œç¬¬ä¸€å±‚ã€å†…å®¹æ‹·è´åˆ°ã€Œç¬¬äºŒå±‚ã€è¿›è¡Œã€Œé‡ç‚¹æ ‡æ³¨ã€ï¼ŒåŒæ—¶å¦‚æœæœ‰å¿…è¦ä¹Ÿå¯ä»¥æ·»åŠ è‡ªå·±çš„ã€Œæ³¨é‡Šã€ï¼Œæ–¹ä¾¿è¿›è¡Œè¾…åŠ©ç†è§£

# é•¿é’ç¬”è®°
> [!tip]
>  å¸¸é’ç¬”è®°ï¼Œä¹Ÿç§°ä¸ºæ°¸ä¹…ç¬”è®°ã€‚å¦‚æœå½“å‰ç¬”è®°çš„é˜…è¯»è®©ä½ äº§ç”Ÿäº†æ–°çš„çµæ„Ÿï¼Œç«™åœ¨ã€ŒåŸå§‹ç´ æã€çš„åŸºç¡€ä¸Šå†™ä¸€ç¯‡æ–‡ç« ï¼Œç„¶åé€šè¿‡ã€ŒåŒå‘é“¾æ¥ã€å°†ç¬”è®°æ·»åŠ åˆ°ã€Œç¬¬ä¸‰å±‚ï¼šå¸¸é’ç¬”è®°ã€ä¸­

# é—ªå¿µ
> [!tip]
> è¿™ä¸€å±‚ä¸»è¦å­˜æ”¾é‚£äº›ã€Œçµå…‰ä¸€ç°ã€çš„å†…å®¹ï¼Œå½“é˜…è¯»ç¬”è®°çš„å½“ä¸‹çªç„¶æŸä¸€æ®µå†…å®¹äº§ç”Ÿäº†ä¸€äº›çµæ„Ÿï¼Œéšæ‰‹è®°å½•åœ¨ã€Œç¬¬å››å±‚ã€ï¼Œå¹¶è®¾ç½®å¥½æ ‡ç­¾ã€Œé—ªå¿µèƒ¶å›Šã€æ–¹ä¾¿å°†æ¥ç´¢å¼•

# å›å½’é—®é¢˜
> [!tip] 
> ä½¿ç”¨å‡ ä¸ªé—®é¢˜ï¼Œå°†æœ¬ç¬”è®°å†…å®¹æ ¸å¿ƒçŸ¥è¯†æç‚¼å‡ºæ¥

1. å®ç° `BufBuilder`, å…¶åº”è¯¥åŒ…å«ä¸€ä¸ª `Vec<u8>` ç”¨äºå­˜æ”¾æ•°æ®ï¼Œå¯¹å…¶å®ç° `Write` trait, `Debug` trait. 
2. ä¸º `u8` å®ç° `Parser` å¹¶æ›´è¿›ä¸€æ­¥å®ç°æ•°å­—æ³›å‹çš„ `Parser`, ä¼˜åŒ–ä»£ç ï¼Œå¯¹æ¯ä¸ªç±»å‹æ— æ³•è§£ææ—¶ï¼Œè¿”å›å…¶ `Default` 
3. å®ç° `Complex` çš„ `Add` traitï¼Œå¯¹å…¶å¼•ç”¨ä¹Ÿå®ç° `Add` trait
4. `Animal` æ˜¯ä¸€ä¸ª trait, å¯¹ `Dog` å’Œ `Cat` åˆ†åˆ«å®ç°è¯¥ traitï¼Œæ¼”ç¤º trait çš„é™æ€åˆ†æ´¾
5. ä½¿ç”¨ `Formatter` å®ç°ä¸€ä¸ªåŠ¨æ€åˆ†æ´¾çš„æ¼”ç¤º