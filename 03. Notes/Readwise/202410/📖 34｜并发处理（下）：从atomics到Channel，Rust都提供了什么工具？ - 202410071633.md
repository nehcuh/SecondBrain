---
title: ğŸ“– 34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ
createdAt: 2024-10-07 16:33
notebook: "[[ğŸ—‚ï¸ Rust ç¼–ç¨‹ç¬¬ä¸€è¯¾]]"
allDay: 
startTime: 
endTime: 
date: 2024-10-07
project: 
area: 
resource: 
archived: 
tags:
  - "#note/ğŸŒ±"
  - "#readwise"
links: 
due: 2024-10-07
nextReview: 2024-10-14
status: "#processing"
---

# åŸæ–‡æ‘˜è¦
> [!tip] 
> å°†åŸå§‹æ–‡ç« ä¸­çš„è¾ƒä¸ºé‡è¦çš„ä¿¡æ¯ã€Œæ‘˜å½•ã€åˆ°ç¬”è®°å½“ä¸­ï¼Œå¯¹ä¸€äº›ç¨å¾®é‡è¦çš„ä¿¡æ¯è¿›è¡Œã€ŒåŠ ç²—å¤„ç†ã€ï¼ˆç”¨ä¸€å¯¹Â ** åŒ…è£¹ç€å†…å®¹ï¼‰ï¼Œåœ¨æœªæ¥ã€Œå›çœ‹ç¬”è®°ã€æ—¶å¿«é€Ÿç†è§£ç¬¬ä¸€å±‚ä¿¡æ¯

å¯¹äºå¹¶å‘çŠ¶æ€ä¸‹è¿™ä¸‰ç§å¸¸è§çš„å·¥ä½œæ¨¡å¼ï¼šè‡ªç”±ç«äº‰æ¨¡å¼ã€map/reduce æ¨¡å¼ã€DAG æ¨¡å¼ï¼Œæˆ‘ä»¬çš„éš¾ç‚¹æ˜¯å¦‚ä½•åœ¨è¿™äº›å¹¶å‘çš„ä»»åŠ¡ä¸­è¿›è¡ŒåŒæ­¥ã€‚atomic / Mutex è§£å†³äº†è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹å¹¶å‘ä»»åŠ¡çš„åŒæ­¥é—®é¢˜ï¼Œä¹Ÿèƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³ map/reduce æ¨¡å¼ä¸‹çš„åŒæ­¥é—®é¢˜ï¼Œå› ä¸ºæ­¤æ—¶åŒæ­¥åªå‘ç”Ÿåœ¨ map å’Œ reduce ä¸¤ä¸ªé˜¶æ®µã€‚

![[Pasted image 20241007163456.png]]
ç„¶è€Œï¼Œå®ƒä»¬æ²¡æœ‰è§£å†³ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ DAG æ¨¡å¼ï¼šå¦‚æœè¿™ç§è®¿é—®éœ€è¦æŒ‰ç…§ä¸€å®šé¡ºåºè¿›è¡Œæˆ–è€…å‰åæœ‰ä¾èµ–å…³ç³»ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿè¿™ä¸ªé—®é¢˜çš„å…¸å‹åœºæ™¯æ˜¯**ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å¼ï¼šç”Ÿäº§è€…ç”Ÿäº§å‡ºæ¥å†…å®¹åï¼Œéœ€è¦æœ‰æœºåˆ¶é€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹**ã€‚æ¯”å¦‚ socket ä¸Šæœ‰æ•°æ®äº†ï¼Œé€šçŸ¥å¤„ç†çº¿ç¨‹æ¥å¤„ç†æ•°æ®ï¼Œå¤„ç†å®Œæˆä¹‹åï¼Œå†é€šçŸ¥ socket æ”¶å‘çš„çº¿ç¨‹å‘é€æ•°æ®ã€‚

## 1. `Condvar`
æ‰€ä»¥ï¼Œæ“ä½œç³»ç»Ÿè¿˜æä¾›äº† `Condvar`. `Condvar` æœ‰ä¸¤ç§çŠ¶æ€
- ç­‰å¾…ï¼ˆwaitï¼‰ï¼šçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶ã€‚
- é€šçŸ¥ï¼ˆnotifyï¼‰ï¼šå½“ `condvar` çš„æ¡ä»¶æ»¡è¶³æ—¶ï¼Œå½“å‰çº¿ç¨‹é€šçŸ¥å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥è¢«å”¤é†’ã€‚é€šçŸ¥å¯ä»¥æ˜¯å•ä¸ªé€šçŸ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªé€šçŸ¥ï¼Œç”šè‡³å¹¿æ’­ï¼ˆé€šçŸ¥æ‰€æœ‰äººï¼‰ã€‚

åœ¨å®è·µä¸­ï¼Œ`Condvar` å¾€å¾€å’Œ `Mutex` ä¸€èµ·ä½¿ç”¨ï¼š**`Mutex` ç”¨äºä¿è¯æ¡ä»¶åœ¨è¯»å†™æ—¶äº’æ–¥ï¼Œ`Condvar` ç”¨äºæ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```rust
use std::{
    sync::{Arc, Condvar, Mutex},
    thread,
    time::Duration,
};

fn main() {
    let pair = Arc::new((Mutex::new(false), Condvar::new()));
    let pair2 = Arc::clone(&pair);

    thread::spawn(move || {
        let (lock, cvar) = &*pair2;
        let mut started = lock.lock().unwrap();
        *started = true;
        eprintln!("I'm a happy worker!");
        // é€šçŸ¥ä¸»çº¿ç¨‹
        cvar.notify_one();
        loop {
            thread::sleep(Duration::from_secs(1));
            println!("working...");
        }
    });

    // ç­‰å¾…å·¥ä½œçº¿ç¨‹çš„é€šçŸ¥
    let (lock, cvar) = &*pair;
    let mut started = lock.lock().unwrap();
    while !*started {
        started = cvar.wait(started).unwrap();
    }
    eprintln!("Worker started!");
}
```

è¿™æ®µä»£ç é€šè¿‡ `condvar`ï¼Œæˆ‘ä»¬å®ç°äº† `worker` çº¿ç¨‹åœ¨æ‰§è¡Œåˆ°ä¸€å®šé˜¶æ®µåé€šçŸ¥ä¸»çº¿ç¨‹ï¼Œç„¶åä¸»çº¿ç¨‹å†åšä¸€äº›äº‹æƒ…ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª `Mutex` ä½œä¸ºäº’æ–¥æ¡ä»¶ï¼Œç„¶ååœ¨ `cvar.wait()` ä¸­ä¼ å…¥è¿™ä¸ª `Mutex`ã€‚è¿™ä¸ªæ¥å£éœ€è¦ä¸€ä¸ª `MutexGuard`ï¼Œä»¥ä¾¿äºçŸ¥é“éœ€è¦å”¤é†’å“ªä¸ª `Mutex` ä¸‹ç­‰å¾…çš„çº¿ç¨‹ï¼š

```rust
pub fn wait<'a, T>(
	&self,
	guard: MutexGurad<'a, T>
) -> LockResult<MutexGurad<'a, T>>
```

## 2. Channel
ä½†æ˜¯ç”¨ `Mutex` å’Œ `Condvar` æ¥å¤„ç†å¤æ‚çš„ DAG å¹¶å‘æ¨¡å¼ä¼šæ¯”è¾ƒåƒåŠ›ã€‚æ‰€ä»¥ï¼Œ Rust è¿˜æä¾›äº†å„ç§å„æ ·çš„ Channel ç”¨äºå¤„ç†å¹¶å‘ä»»åŠ¡ä¹‹é—´çš„é€šè®¯ã€‚

**Channel æŠŠé”å°è£…åœ¨äº†é˜Ÿåˆ—å†™å…¥å’Œè¯»å–çš„å°å—åŒºåŸŸå†…ï¼Œç„¶åæŠŠè¯»è€…å’Œå†™è€…å®Œå…¨åˆ†ç¦»**ï¼Œä½¿å¾—è¯»è€…è¯»å–æ•°æ®å’Œå†™è€…å†™å…¥æ•°æ®ï¼Œå¯¹å¼€å‘è€…è€Œè¨€ï¼Œé™¤äº†æ½œåœ¨çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¤–ï¼Œå®Œå…¨å’Œé”æ— å…³ï¼Œå°±åƒè®¿é—®ä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—ä¸€æ ·ã€‚æ‰€ä»¥ï¼Œå¯¹äºå¤§éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”¨ Channel æˆ–è€…ç±»ä¼¼çš„æ€æƒ³å¤„ç† (æ¯”å¦‚ actor model).

Channel åœ¨å…·ä½“å“¦å®ç°çš„æ—¶å€™ï¼Œæ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œä¼šé€‰æ‹©ä¸åŒçš„å·¥å…·ã€‚

Rust æä¾›äº†ä»¥ä¸‹å››ç§ Channel:
- `oneshot`: è¿™å¯èƒ½æ˜¯æœ€ç®€å•çš„ Channelï¼Œå†™è€…å°±åªå‘ä¸€æ¬¡æ•°æ®ï¼Œè€Œè¯»è€…ä¹Ÿåªè¯»ä¸€æ¬¡ã€‚è¿™ç§ä¸€æ¬¡æ€§çš„ã€å¤šä¸ªçº¿ç¨‹é—´çš„åŒæ­¥å¯ä»¥ç”¨ `oneshot` channel å®Œæˆã€‚ç”±äº `oneshot` ç‰¹æ®Šçš„ç”¨é€”ï¼Œå®ç°çš„æ—¶å€™å¯ä»¥ç›´æ¥ç”¨ atomic swap æ¥å®Œæˆã€‚
- `rendezvous`: å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ Channel æ¥æ§åˆ¶çº¿ç¨‹é—´åŒæ­¥ï¼Œå¹¶ä¸éœ€è¦å‘é€æ•°æ®ã€‚`rendezvous` channel æ˜¯ channel size ä¸º 0 çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ `Mutex` + `Condvar` å®ç°å°±è¶³å¤Ÿäº†ï¼Œåœ¨å…·ä½“å®ç°ä¸­ï¼Œ`rendezvous` channel å…¶å®ä¹Ÿæ˜¯ `Mutex`  + `Condvar` çš„ä¸€ä¸ªåŒ…è£…ã€‚
- `bounded`: **`bounded` channel æœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†é˜Ÿåˆ—æœ‰ä¸Šé™ã€‚ä¸€æ—¦é˜Ÿåˆ—è¢«å†™æ»¡äº†ï¼Œå†™è€…ä¹Ÿéœ€è¦è¢«æŒ‚èµ·ç­‰å¾…**ã€‚å½“é˜»å¡å‘ç”Ÿåï¼Œè¯»è€…ä¸€æ—¦è¯»å–æ•°æ®ï¼Œchannel å†…éƒ¨å°±ä¼šä½¿ç”¨ `Condvar` çš„ `notify_one` é€šçŸ¥å†™è€…ï¼Œå”¤é†’æŸä¸ªå†™è€…ä½¿å…¶èƒ½å¤Ÿç»§ç»­å†™å…¥ã€‚å› æ­¤ï¼Œå®ç°ä¸­ï¼Œä¸€èˆ¬ä¼šç”¨åˆ° `Mutex` + `Condvar` + `VecDeque` æ¥å®ç°ï¼›å¦‚æœä¸ç”¨ `Condvar`ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `thread::park` + `thread::notify` æ¥å®Œæˆï¼ˆ[flume](https://github.com/zesterer/flume) [GitHub - zesterer/flume: A safe and fast multi-producer, multi-consumer channel.](https://github.com/zesterer/flume)çš„åšæ³•ï¼‰ï¼›å¦‚æœä¸ç”¨ `VecDeque`ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒå‘é“¾è¡¨æˆ–è€…å…¶å®ƒçš„ ring buffer çš„å®ç°ã€‚
- `unbounded`ï¼šqueue æ²¡æœ‰ä¸Šé™ï¼Œå¦‚æœå†™æ»¡äº†ï¼Œå°±è‡ªåŠ¨æ‰©å®¹ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒRust çš„å¾ˆå¤šæ•°æ®ç»“æ„å¦‚ `Vec` ã€`VecDeque` éƒ½æ˜¯è‡ªåŠ¨æ‰©å®¹çš„ã€‚`unbounded` å’Œ `bounded` ç›¸æ¯”ï¼Œé™¤äº†ä¸é˜»å¡å†™è€…ï¼Œå…¶å®ƒå®ç°éƒ½å¾ˆç±»ä¼¼ã€‚
æ‰€æœ‰è¿™äº› channel ç±»å‹ï¼ŒåŒæ­¥å’Œå¼‚æ­¥çš„å®ç°æ€è·¯å¤§åŒå°å¼‚ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºæŒ‚èµ· / å”¤é†’çš„å¯¹è±¡ã€‚åœ¨åŒæ­¥çš„ä¸–ç•Œé‡Œï¼ŒæŒ‚èµ· / å”¤é†’çš„å¯¹è±¡æ˜¯çº¿ç¨‹ï¼›è€Œå¼‚æ­¥çš„ä¸–ç•Œé‡Œï¼Œæ˜¯ç²’åº¦å¾ˆå°çš„ taskã€‚

æ ¹æ® Channel è¯»è€…å’Œå†™è€…çš„æ•°é‡ï¼ŒChannel åˆå¯ä»¥åˆ†ä¸ºï¼š
- `SPSC`ï¼šSingle-Producer Single-Consumerï¼Œå•ç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚æœ€ç®€å•ï¼Œå¯ä»¥ä¸ä¾èµ–äº Mutexï¼Œåªç”¨ atomics å°±å¯ä»¥å®ç°ã€‚
- `SPMC`ï¼šSingle-Producer Multi-Consumerï¼Œå•ç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨æ¶ˆè´¹è€…è¿™ä¾§è¯»å–æ—¶åŠ é”ã€‚
- `MPSC`ï¼šMulti-Producer Single-Consumerï¼Œå¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…è¿™ä¾§å†™å…¥æ—¶åŠ é”ã€‚
- `MPMC`ï¼šMulti-Producer Multi-Consumerã€‚å¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…å†™å…¥æˆ–è€…æ¶ˆè´¹è€…è¯»å–æ—¶åŠ é”ã€‚
åœ¨ä¼—å¤š Channel ç±»å‹ä¸­ï¼Œä½¿ç”¨æœ€å¹¿çš„æ˜¯ `MPSC` channelï¼Œå¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ï¼Œå› ä¸ºå¾€å¾€æˆ‘ä»¬å¸Œæœ›é€šè¿‡å•æ¶ˆè´¹è€…æ¥ä¿è¯ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯çš„æ•°æ®ç»“æ„æœ‰ç‹¬å çš„å†™è®¿é—®ã€‚
![[Pasted image 20241012100550.png]]
æ¯”å¦‚ï¼Œåœ¨ [xunmi](https://github.com/tyrchen/xunmi/blob/master/src/indexer.rs#L50)[xunmi/src/indexer.rs at master Â· tyrchen/xunmi Â· GitHub](https://github.com/tyrchen/xunmi/blob/master/src/indexer.rs#L50) çš„å®ç°ä¸­ï¼Œ`index writer` å†…éƒ¨æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹çš„å®ç°ï¼Œä½†åœ¨ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å®ƒçš„å¯å†™å¼•ç”¨ã€‚å¦‚æœè¦èƒ½å¤Ÿåœ¨å„ç§ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ `index writer`ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸å°†å…¶ç”¨ `Arc<Mutex<T>>` åŒ…è£¹èµ·æ¥ï¼Œä½†è¿™æ ·åœ¨ç´¢å¼•å¤§é‡æ•°æ®æ—¶æ•ˆç‡å¤ªä½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ `MPSC` channelï¼Œè®©å„ç§ä¸Šä¸‹æ–‡éƒ½æŠŠæ•°æ®å‘é€ç»™å•ä¸€çš„çº¿ç¨‹ï¼Œä½¿ç”¨ `index writer` ç´¢å¼•ï¼Œè¿™æ ·å°±é¿å…äº†é”ï¼š

```rust
pub struct IndexInner {
	index: Index,
	reader: IndexReader,
	config: IndexConfig,
	updater: Send<Input>
}

pub struct IndexUpdater {
	sender: Sender<Input>,
	t2s: bool,
	schema: Schema
}

impl Indexer {
	// æ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ª index
	pub fn open_or_create(config: IndexConfig) -> Result<Self> {
		let schema = config.schema.clone();
		let index = if let Some(dir) = &config.path {
			fs::create_dir_all(dir)?;
			let dir = MmapDirectory::open(dir)?;
			Index::open_or_create(dir, schema.clone())?
		} else {
			Index::create_in_ram(schema.clone())
		};

		Self::set_tokenize(&index, &config);

		let mut writer = index.writer(config.write_memory)?;

		// åˆ›å»ºä¸€ä¸ª unbound MPSC channel
		let (s, r) = unbounded::<Input>();

		// å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä» channel çš„ reader ä¸­è¯»å–æ•°æ®
		thread::spawn(move || {
			for input in r {
				// ç„¶åç”¨ index writer å¤„ç†è¿™ä¸ª input
				if let Err(e) = input.process(&mut writer, &schema) {
					warn!("Failed to process input. Error: {:?}", e);
				} 
			}
		});

		Self::new(index, config, s)
	}
}
```


# é‡ç‚¹æ‘˜è¦
> [!tip] 
> åœ¨å®Œæˆã€Œç¬¬ä¸€å±‚ï¼šåŸæ–‡æ‘˜è¦ã€åé©¬ä¸Šå°±æ•´ç†ã€Œç¬¬äºŒå±‚ï¼šé‡ç‚¹æ‘˜è¦ã€ï¼Œè™½ç„¶éœ€è¦éµå¾ªã€Œä¸åŒçš„æ—¶é—´æ®µå®Œæˆä¸åŒå±‚çº§ã€çš„è§„åˆ™ï¼Œä½†æ˜¯åœ¨é˜…è¯»æˆ–æ•´ç†ç¬”è®°çš„å½“ä¸‹ï¼Œå¦‚æœè§‰å¾—æœ‰äº›å†…å®¹éœ€è¦é‡ç‚¹æ ‡æ³¨ï¼Œéœ€è¦ç¬¬ä¸€æ—¶é—´å°†ã€Œç¬¬ä¸€å±‚ã€å†…å®¹æ‹·è´åˆ°ã€Œç¬¬äºŒå±‚ã€è¿›è¡Œã€Œé‡ç‚¹æ ‡æ³¨ã€ï¼ŒåŒæ—¶å¦‚æœæœ‰å¿…è¦ä¹Ÿå¯ä»¥æ·»åŠ è‡ªå·±çš„ã€Œæ³¨é‡Šã€ï¼Œæ–¹ä¾¿è¿›è¡Œè¾…åŠ©ç†è§£

# é•¿é’ç¬”è®°
> [!tip]
>  å¸¸é’ç¬”è®°ï¼Œä¹Ÿç§°ä¸ºæ°¸ä¹…ç¬”è®°ã€‚å¦‚æœå½“å‰ç¬”è®°çš„é˜…è¯»è®©ä½ äº§ç”Ÿäº†æ–°çš„çµæ„Ÿï¼Œç«™åœ¨ã€ŒåŸå§‹ç´ æã€çš„åŸºç¡€ä¸Šå†™ä¸€ç¯‡æ–‡ç« ï¼Œç„¶åé€šè¿‡ã€ŒåŒå‘é“¾æ¥ã€å°†ç¬”è®°æ·»åŠ åˆ°ã€Œç¬¬ä¸‰å±‚ï¼šå¸¸é’ç¬”è®°ã€ä¸­

# é—ªå¿µ
> [!tip]
> è¿™ä¸€å±‚ä¸»è¦å­˜æ”¾é‚£äº›ã€Œçµå…‰ä¸€ç°ã€çš„å†…å®¹ï¼Œå½“é˜…è¯»ç¬”è®°çš„å½“ä¸‹çªç„¶æŸä¸€æ®µå†…å®¹äº§ç”Ÿäº†ä¸€äº›çµæ„Ÿï¼Œéšæ‰‹è®°å½•åœ¨ã€Œç¬¬å››å±‚ã€ï¼Œå¹¶è®¾ç½®å¥½æ ‡ç­¾ã€Œé—ªå¿µèƒ¶å›Šã€æ–¹ä¾¿å°†æ¥ç´¢å¼•

# å›å½’é—®é¢˜
> [!tip] 
> ä½¿ç”¨å‡ ä¸ªé—®é¢˜ï¼Œå°†æœ¬ç¬”è®°å†…å®¹æ ¸å¿ƒçŸ¥è¯†æç‚¼å‡ºæ¥